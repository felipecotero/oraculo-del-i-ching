<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Ching: El Espejo de las Mutaciones</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', 'serif'],
                        cinzel: ['Cinzel', 'serif'],
                    },
                    colors: {
                        ink: '#111111', paper: '#F2E8D5', cinnabar: '#9A1B1B', jade: '#3A5F4C', gold: '#C5A059',
                    },
                    animation: {
                        'fadeIn': 'fadeIn 1.2s ease-out forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #F2E8D5; color: #111111;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.12'/%3E%3C/svg%3E");
            overflow-x: hidden;
        }
        .vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 200px rgba(40, 30, 15, 0.5); pointer-events: none; z-index: 0; }
        .ink-brush { background-color: #111; mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='rough'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.05' numOctaves='2'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23rough)'/%3E%3C/svg%3E"); opacity: 0.9; }
        .hex-sticky { position: sticky; top: 2rem; align-self: start; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #9A1B1B; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="vignette"></div>
    <div id="root" class="relative z-10 min-h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { jsPDF } = window.jspdf;

        const apiKey = "AIzaSyBRwAd5v0Pgbh6QjWBLAuCy28Z8BG0Fwig"; 

        // --- ARTE SVG (RESPALDO INMEDIATO) ---
        const INK_LANDSCAPES = [
            `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E%3Cpath d='M0 200L200 100C250 80 300 150 400 50C500 -50 600 150 800 100V200H0Z' fill='%23111' opacity='0.1'/%3E%3Cpath d='M100 200L300 50C350 30 400 120 500 80C600 40 700 180 800 150V200H100Z' fill='%23111' opacity='0.2'/%3E%3C/svg%3E`,
            `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E%3Cpath d='M0 150C200 180 300 100 500 120C700 140 750 80 800 100V200H0Z' fill='%23111' opacity='0.1'/%3E%3Cpath d='M0 180C250 200 400 120 600 150C750 180 780 140 800 160V200H0Z' fill='%23111' opacity='0.2'/%3E%3C/svg%3E`,
            `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E%3Ccircle cx='100' cy='50' r='80' fill='%23111' opacity='0.05'/%3E%3Ccircle cx='250' cy='80' r='100' fill='%23111' opacity='0.08'/%3E%3Ccircle cx='500' cy='40' r='120' fill='%23111' opacity='0.05'/%3E%3Ccircle cx='700' cy='90' r='90' fill='%23111' opacity='0.08'/%3E%3C/svg%3E`
        ];

        // --- DATOS Y LÃ“GICA ---
        const TRIGRAMS = {
            '111': { name: "Ch'ien", element: "Cielo", meaning: "Lo Creativo", quality: "Fuerza" },
            '000': { name: "K'un", element: "Tierra", meaning: "Lo Receptivo", quality: "Entrega" },
            '100': { name: "Chen", element: "Trueno", meaning: "Lo Suscitativo", quality: "Movimiento" },
            '010': { name: "K'an", element: "Agua", meaning: "Lo Abismal", quality: "Peligro" },
            '001': { name: "Ken", element: "MontaÃ±a", meaning: "El Aquietamiento", quality: "Quietud" },
            '110': { name: "Sun", element: "Viento", meaning: "Lo Suave", quality: "PenetraciÃ³n" },
            '101': { name: "Li", element: "Fuego", meaning: "Lo Adherente", quality: "Claridad" },
            '011': { name: "Tui", element: "Lago", meaning: "Lo Sereno", quality: "AlegrÃ­a" }
        };

        const KING_WEN_MAP = {
            '111111': 1, '000000': 2, '100010': 3, '010001': 4, '111010': 5, '010111': 6, '010000': 7, '000010': 8,
            '111011': 9, '110111': 10, '111000': 11, '000111': 12, '101111': 13, '111101': 14, '001000': 15, '000100': 16,
            '100110': 17, '011001': 18, '110000': 19, '000011': 20, '100101': 21, '101001': 22, '000001': 23, '100000': 24,
            '100111': 25, '111001': 26, '100001': 27, '011110': 28, '010010': 29, '101101': 30, '001110': 31, '011100': 32,
            '001111': 33, '111100': 34, '000101': 35, '101000': 36, '101010': 37, '010101': 38, '001010': 39, '010100': 40,
            '110001': 41, '100011': 42, '111110': 43, '011111': 44, '000110': 45, '011000': 46, '010110': 47, '011010': 48,
            '101110': 49, '011101': 50, '100100': 51, '001001': 52, '001011': 53, '110100': 54, '101100': 55, '001101': 56,
            '011011': 57, '110110': 58, '010011': 59, '110010': 60, '110011': 61, '001100': 62, '101010': 63, '010101': 64
        };

        // --- BASE DE DATOS CURADA 1-64 ---
        const ORACLE_DB = {
            1: { t: "Lo Creativo", d: "El Creativo obra elevado logro. Propicio es perseverar.", i: "El cielo se mueve con poder." },
            2: { t: "Lo Receptivo", d: "Lo Receptivo obra elevado Ã©xito. Propicia es la perseverancia de una yegua.", i: "La condiciÃ³n de la tierra es la entrega receptiva." },
            3: { t: "La Dificultad Inicial", d: "Obra elevado Ã©xito. Propicio es perseverar. No se debe emprender nada.", i: "Nubes y Trueno tejen la red de la dificultad." },
            4: { t: "La Necedad Juvenil", d: "Tiene Ã©xito. No soy yo quien busca al joven necio, Ã©l me busca a mÃ­.", i: "Un manantial al pie de la montaÃ±a." },
            5: { t: "La Espera", d: "Si eres veraz, tendrÃ¡s luz y Ã©xito. Perseverancia trae ventura.", i: "Nubes suben al cielo: tiempo de comer y beber." },
            6: { t: "El Conflicto", d: "Eres veraz y te frenan. Detenerse con cautela a mitad de camino trae ventura.", i: "Cielo y Agua se mueven en direcciones opuestas." },
            7: { t: "El EjÃ©rcito", d: "El ejÃ©rcito necesita perseverancia y un hombre fuerte.", i: "En el centro de la tierra hay agua." },
            8: { t: "La Solidaridad", d: "Trae ventura. Indaga el orÃ¡culo una vez mÃ¡s.", i: "Sobre la tierra hay agua: uniÃ³n natural." },
            9: { t: "La Fuerza Domesticadora de lo PequeÃ±o", d: "Ã‰xito. Densas nubes, ninguna lluvia del oeste.", i: "El viento sopla a travÃ©s del cielo." },
            10: { t: "El Porte", d: "Pisar la cola del tigre. Ã‰ste no muerde. Ã‰xito.", i: "Cielo arriba, lago abajo." },
            11: { t: "La Paz", d: "Lo pequeÃ±o se va, llega lo grande. Ventura.", i: "Cielo y tierra se unen." },
            12: { t: "El Estancamiento", d: "Los malvados no favorecen la perseverancia del noble.", i: "Cielo y tierra no se unen." },
            13: { t: "La Comunidad con los Hombres", d: "Ã‰xito. Es propicio atravesar las grandes aguas.", i: "Cielo junto con fuego." },
            14: { t: "La Gran PosesiÃ³n", d: "Ã‰xito en medida suprema.", i: "El fuego en lo alto del cielo." },
            15: { t: "La Modestia", d: "Crea Ã©xito. El noble lleva a buen tÃ©rmino.", i: "En medio de la tierra hay una montaÃ±a." },
            16: { t: "El Entusiasmo", d: "Es propicio designar ayudantes y hacer marchar ejÃ©rcitos.", i: "El trueno surge estruendoso de la tierra." },
            17: { t: "El Seguimiento", d: "Elevado Ã©xito. Propicia es la perseverancia.", i: "En el centro del lago estÃ¡ el trueno." },
            18: { t: "El Trabajo en lo Echado a Perder", d: "Elevado Ã©xito. Es propicio atravesar las grandes aguas.", i: "Viento sopla bajo la montaÃ±a." },
            19: { t: "El Acercamiento", d: "Elevado Ã©xito. Propicia es la perseverancia.", i: "La tierra encima del lago." },
            20: { t: "La ContemplaciÃ³n", d: "Se ha cumplido la abluciÃ³n, pero aÃºn no la ofrenda.", i: "El viento sopla sobre la tierra." },
            21: { t: "La Mordedura Tajante", d: "Tiene Ã©xito. Es propicio dejar que se ejerza la justicia.", i: "Trueno y relÃ¡mpago." },
            22: { t: "La Gracia", d: "Ã‰xito en lo pequeÃ±o.", i: "Fuego al pie de la montaÃ±a." },
            23: { t: "La DesintegraciÃ³n", d: "No es propicio ir a parte alguna.", i: "La montaÃ±a descansa sobre la tierra." },
            24: { t: "El Retorno", d: "Salidas y entradas sin falla. Al sÃ©ptimo dÃ­a viene el retorno.", i: "El trueno dentro de la tierra." },
            25: { t: "La Inocencia", d: "Elevado Ã©xito. Si uno no es recto, tendrÃ¡ desventura.", i: "Bajo el cielo marcha el trueno." },
            26: { t: "La Fuerza Domesticadora de lo Grande", d: "Propicia es la perseverancia. No comer en casa trae ventura.", i: "Cielo dentro de la montaÃ±a." },
            27: { t: "La NutriciÃ³n", d: "Perseverancia trae ventura. Presta atenciÃ³n a la boca.", i: "Al pie de la montaÃ±a estÃ¡ el trueno." },
            28: { t: "La Preponderancia de lo Grande", d: "La viga maestra se dobla. Es propicio tener a donde ir.", i: "El lago inunda sobre los Ã¡rboles." },
            29: { t: "Lo Abismal", d: "Si eres veraz, tendrÃ¡s Ã©xito en tu corazÃ³n.", i: "El agua fluye ininterrumpidamente." },
            30: { t: "Lo Adherente", d: "Perseverancia. Cuidar de la vaca trae ventura.", i: "La claridad se eleva dos veces." },
            31: { t: "La Influencia", d: "Ã‰xito. Tomar una muchacha trae ventura.", i: "Sobre la montaÃ±a hay un lago." },
            32: { t: "La DuraciÃ³n", d: "Ã‰xito. No hay tacha.", i: "Trueno y viento." },
            33: { t: "La Retirada", d: "Ã‰xito. En lo pequeÃ±o es propicia la perseverancia.", i: "Bajo el cielo estÃ¡ la montaÃ±a." },
            34: { t: "El Gran Poder", d: "Es propicia la perseverancia.", i: "El trueno en lo alto del cielo." },
            35: { t: "El Progreso", d: "El fuerte prÃ­ncipe es honrado con caballos.", i: "El sol se eleva sobre la tierra." },
            36: { t: "El Oscurecimiento de la Luz", d: "Es propicio ser perseverante en la emergencia.", i: "La luz se ha sumergido en la tierra." },
            37: { t: "La Familia", d: "Es propicia la perseverancia de la mujer.", i: "El viento surge del fuego." },
            38: { t: "El Antagonismo", d: "En cosas pequeÃ±as, ventura.", i: "Arriba el fuego, abajo el lago." },
            39: { t: "El Impedimento", d: "Es propicio el oeste y el sur.", i: "Sobre la montaÃ±a hay agua." },
            40: { t: "La LiberaciÃ³n", d: "Es propicio el oeste y el sur.", i: "El trueno y la lluvia surgen." },
            41: { t: "La Merma", d: "Si hay veracidad, se logra elevado Ã©xito.", i: "Al pie de la montaÃ±a estÃ¡ el lago." },
            42: { t: "El Aumento", d: "Es propicio emprender algo.", i: "Viento y trueno." },
            43: { t: "La ResoluciÃ³n", d: "Uno debe dar a conocer el asunto en la corte.", i: "El lago ha subido al cielo." },
            44: { t: "El Acoplamiento", d: "La muchacha es poderosa. No tomarla.", i: "Bajo el cielo estÃ¡ el viento." },
            45: { t: "La ReuniÃ³n", d: "Ã‰xito. El rey se acerca a su templo.", i: "El lago sobre la tierra." },
            46: { t: "El Ascenso", d: "Elevado Ã©xito. Hay que ver al gran hombre.", i: "En el centro de la tierra crece madera." },
            47: { t: "La DesazÃ³n", d: "Ã‰xito. Perseverancia. El gran hombre opera ventura.", i: "El lago no tiene agua." },
            48: { t: "El Pozo", d: "Uno cambia de ciudad, pero no de pozo.", i: "Sobre la madera hay agua." },
            49: { t: "La RevoluciÃ³n", d: "En tu propio dÃ­a encontrarÃ¡s fe.", i: "Fuego en el lago." },
            50: { t: "El Caldero", d: "Elevada ventura. Ã‰xito.", i: "Por encima de la madera hay fuego." },
            51: { t: "Lo Suscitativo", d: "Llega la conmociÃ³n.", i: "El trueno repetido." },
            52: { t: "El Aquietamiento", d: "Aquietar su espalda.", i: "MontaÃ±as estribadas." },
            53: { t: "La EvoluciÃ³n", d: "La muchacha se casa. Ventura.", i: "Sobre la montaÃ±a hay un Ã¡rbol." },
            54: { t: "La Muchacha que se Casa", d: "Las empresas traen desventura.", i: "Sobre el lago hay un trueno." },
            55: { t: "La Plenitud", d: "El rey la alcanza. No estÃ©s triste.", i: "Trueno y rayos llegan a la vez." },
            56: { t: "El Andariego", d: "Ã‰xito en lo pequeÃ±o.", i: "Fuego sobre la montaÃ±a." },
            57: { t: "Lo Suave", d: "Ã‰xito en lo pequeÃ±o.", i: "Vientos seguidos." },
            58: { t: "Lo Sereno", d: "Ã‰xito. Es propicia la perseverancia.", i: "Lagos que reposan uno sobre otro." },
            59: { t: "La DisoluciÃ³n", d: "Ã‰xito. El rey se acerca a su templo.", i: "El viento roza por encima el agua." },
            60: { t: "La RestricciÃ³n", d: "Ã‰xito. Una restricciÃ³n amarga no se debe perseverar.", i: "Agua sobre el lago." },
            61: { t: "La Verdad Interior", d: "Cerdos y peces. Â¡Ventura!", i: "Viento sobre el lago." },
            62: { t: "La Preponderancia de lo PequeÃ±o", d: "PequeÃ±as cosas pueden hacerse.", i: "Trueno sobre la montaÃ±a." },
            63: { t: "DespuÃ©s de la ConsumaciÃ³n", d: "Ã‰xito en lo pequeÃ±o.", i: "El agua estÃ¡ sobre el fuego." },
            64: { t: "Antes de la ConsumaciÃ³n", d: "Si el zorro se moja la cola, nada es propicio.", i: "El fuego estÃ¡ sobre el agua." }
        };

        // --- FUNCIONES LÃ“GICAS ---
        const generateDeepAnalysis = (upperBin, lowerBin, hexName) => {
            const upper = TRIGRAMS[upperBin];
            const lower = TRIGRAMS[lowerBin];
            return `ANÃLISIS ESTRUCTURAL:\nEl Trigrama ${upper.name} (${upper.element}) se sitÃºa sobre ${lower.name} (${lower.element}).\n\nDINÃMICA:\nTu mundo interno (${lower.quality}) interactÃºa con un entorno de ${upper.quality}. La clave estÃ¡ en cÃ³mo ${lower.element} soporta o impulsa a ${upper.element}.\n\nTIEMPO (Loisi):\nEstÃ¡s en la estaciÃ³n de "${hexName}". No es un evento aislado, sino un clima que requiere adaptaciÃ³n.`;
        };

        const generateProceduralInk = (upperBin, lowerBin) => {
            // Generador de respaldo SVG simple
            const colors = ['#111', '#222'];
            let svg = "";
            if (upperBin === '111' || upperBin === '101') svg += `<circle cx='600' cy='50' r='40' fill='${colors[0]}' opacity='0.1'/>`;
            if (lowerBin === '000' || lowerBin === '001') svg += `<path d='M0 200 L800 200 L400 100 Z' fill='${colors[1]}' opacity='0.1'/>`;
            if (svg === "") svg = `<rect width='800' height='200' fill='#111' opacity='0.05'/>`;
            return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E${svg}%3E%3C/svg%3E`;
        };

        const getHexInfo = (linesInput) => {
            const bin = linesInput.map(l => (l===7||l===9)?'1':'0').join('');
            const id = KING_WEN_MAP[bin];
            const dbEntry = ORACLE_DB[id];
            
            const lowerBin = bin.substring(0,3);
            const upperBin = bin.substring(3,6);
            const analysis = generateDeepAnalysis(upperBin, lowerBin, dbEntry.t);
            const inkImage = generateProceduralInk(upperBin, lowerBin); 

            return { ...dbEntry, id, analysis, inkImage, j: {p: "Escucha el silencio.", a: "Medita sobre el signo."} };
        };

        // --- APP ---
        function IChingApp() {
            const [phase, setPhase] = useState('INTRO');
            const [method, setMethod] = useState(null);
            const [lines, setLines] = useState([]);
            const [genImage, setGenImage] = useState(INK_LANDSCAPES[0]);
            const [isGenerating, setIsGenerating] = useState(false);
            const scrollRef = useRef(null);

            const generateHexagramVisual = async (info) => {
                setIsGenerating(true);
                // Si hay API Key, intentamos generar
                if (apiKey) {
                    const prompt = `Minimalist ink wash painting. Concept: "${info.t}" - ${info.i}. Traditional Chinese art style, black and white, abstract landscape.`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } })
                        });
                        
                        if (!response.ok) throw new Error(`API Error: ${response.status}`);
                        
                        const result = await response.json();
                        if (result.predictions?.[0]?.bytesBase64Encoded) {
                            setGenImage(`data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`);
                            setIsGenerating(false);
                            return; 
                        }
                    } catch (e) {
                        console.error("Fallo generaciÃ³n, usando respaldo:", e);
                    }
                }
                // Fallback elegante si falla o no hay key
                setTimeout(() => {
                    setGenImage(info.inkImage); 
                    setIsGenerating(false);
                }, 1000);
            };

            const castLine = () => {
                const r = Math.random() * 16;
                if (method === 'coin') return r < 2 ? 6 : r < 8 ? 7 : r < 14 ? 8 : 9;
                return r < 1 ? 6 : r < 6 ? 7 : r < 13 ? 8 : 9;
            };

            const handleCast = () => { if (lines.length < 6) setLines(prev => [...prev, castLine()]); };

            useEffect(() => {
                if (lines.length === 6 && phase === 'RITUAL') {
                    setTimeout(() => setPhase('REVELATION'), 800);
                }
                if(phase === 'RITUAL' && scrollRef.current) scrollRef.current.scrollIntoView({behavior:'smooth'});
            }, [lines, phase]);

            const currentData = (phase === 'REVELATION' && lines.length === 6) ? getHexInfo(lines) : null;

            const downloadPDF = () => {
                const doc = new jsPDF();
                doc.setFillColor(242, 232, 213); doc.rect(0,0,210,297,'F'); // Fondo
                doc.setDrawColor(154, 27, 27); doc.setLineWidth(1); doc.rect(10,10,190,277); // Marco
                
                doc.setTextColor(154, 27, 27); doc.setFontSize(24); doc.setFont("times", "bold");
                doc.text(currentData.t.toUpperCase(), 105, 30, {align:'center'});
                
                doc.setTextColor(0); doc.setFontSize(12); doc.setFont("times", "normal");
                const splitD = doc.splitTextToSize(currentData.d, 150);
                doc.text(splitD, 30, 50);
                
                // Dibujar Hexagrama Visualmente
                let y = 80;
                [...lines].reverse().forEach(v => {
                    const isYang = (v===7||v===9);
                    doc.setFillColor(0);
                    if(isYang) doc.rect(70, y, 70, 4, 'F');
                    else { doc.rect(70, y, 30, 4, 'F'); doc.rect(110, y, 30, 4, 'F'); }
                    y += 10;
                });

                doc.setFont("helvetica", "italic"); doc.setFontSize(10);
                const splitA = doc.splitTextToSize(currentData.analysis, 150);
                doc.text(splitA, 30, 160);
                
                doc.save(`iching_${currentData.id}.pdf`);
            };

            const LineComp = ({ value }) => {
                const isYang = value === 7 || value === 9;
                return (
                    <div className="w-full h-6 my-1 flex justify-center">
                        <div className="w-full max-w-xs flex justify-between">
                            {isYang ? <div className="w-full h-4 bg-ink rounded-sm"></div> : 
                            <><div className="w-[45%] h-4 bg-ink rounded-sm"></div><div className="w-[45%] h-4 bg-ink rounded-sm"></div></>}
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-4xl mx-auto p-6 font-serif text-ink min-h-screen flex flex-col items-center">
                    <h1 className="text-4xl font-cinzel text-cinnabar mb-8 tracking-widest">I CHING</h1>

                    {phase === 'INTRO' && (
                        <div className="text-center animate-fadeIn">
                            <p className="text-xl italic mb-12">"El camino es fatal como la flecha,<br/>pero en las grietas estÃ¡ Dios, que acecha."</p>
                            <div className="flex gap-8 justify-center">
                                <button onClick={() => { setMethod('yarrow'); setPhase('RITUAL'); }} className="border-2 border-cinnabar text-cinnabar px-8 py-4 hover:bg-cinnabar hover:text-paper transition-colors font-cinzel uppercase">Tallos (Sabio)</button>
                                <button onClick={() => { setMethod('coin'); setPhase('RITUAL'); }} className="border-2 border-ink text-ink px-8 py-4 hover:bg-ink hover:text-paper transition-colors font-cinzel uppercase">Monedas (Guerrero)</button>
                            </div>
                        </div>
                    )}

                    {phase === 'RITUAL' && (
                        <div className="w-full max-w-md animate-fadeIn flex flex-col items-center">
                            <div className="flex flex-col-reverse gap-2 mb-8 w-full p-8 border border-ink/10 bg-white/40">
                                {lines.map((v, i) => <LineComp key={i} value={v} />)}
                                {lines.length === 0 && <p className="text-center opacity-50 italic">El vacÃ­o fÃ©rtil...</p>}
                            </div>
                            {lines.length < 6 && (
                                <button onClick={handleCast} ref={scrollRef} className="w-24 h-24 rounded-full border-2 border-ink flex items-center justify-center hover:bg-ink hover:text-paper transition-colors text-2xl shadow-lg">
                                    {method === 'yarrow' ? 'ðŸŒ¿' : 'ðŸª™'}
                                </button>
                            )}
                            {lines.length === 6 && <p className="text-cinnabar animate-pulse">Revelando...</p>}
                        </div>
                    )}

                    {phase === 'REVELATION' && currentData && (
                        <div className="w-full animate-fadeIn">
                            <div className="w-full h-64 mb-8 bg-black/5 relative overflow-hidden flex items-center justify-center border-y-2 border-ink/10">
                                {isGenerating ? <p className="animate-pulse font-cinzel">Invocando visiÃ³n...</p> : 
                                <>
                                    <img src={genImage} className="w-full h-full object-cover opacity-80" />
                                    <button onClick={() => generateHexagramVisual(currentData)} className="absolute bottom-4 right-4 bg-ink text-paper px-4 py-2 text-xs uppercase tracking-widest hover:bg-cinnabar transition-colors">Invocar VisiÃ³n</button>
                                </>}
                            </div>

                            <div className="grid md:grid-cols-3 gap-8">
                                <div className="md:col-span-1 bg-white/50 p-6 border-t-4 border-cinnabar">
                                    <h2 className="text-3xl font-bold text-cinnabar mb-2">{currentData.t}</h2>
                                    <h3 className="text-lg italic opacity-70 mb-6">Hexagrama {currentData.id}</h3>
                                    <div className="flex flex-col-reverse gap-2">{lines.map((v,i)=><LineComp key={i} value={v} />)}</div>
                                    <button onClick={downloadPDF} className="mt-8 w-full border border-ink text-xs uppercase py-2 hover:bg-ink hover:text-paper transition-colors">Descargar PDF</button>
                                    <button onClick={()=>{setLines([]); setPhase('INTRO'); setMethod(null);}} className="mt-2 w-full text-xs uppercase py-2 opacity-50 hover:opacity-100">Nueva Lectura</button>
                                </div>
                                
                                <div className="md:col-span-2 space-y-8">
                                    <div>
                                        <h3 className="text-cinnabar font-bold uppercase tracking-widest border-b border-cinnabar/20 mb-2">El Dictamen</h3>
                                        <p className="text-xl leading-relaxed">{currentData.d}</p>
                                    </div>
                                    <div>
                                        <h3 className="text-jade font-bold uppercase tracking-widest border-b border-jade/20 mb-2">La Imagen</h3>
                                        <p className="text-lg italic opacity-80">"{currentData.i}"</p>
                                    </div>
                                    <div className="bg-ink/5 p-6 rounded text-sm whitespace-pre-line">
                                        {currentData.analysis}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IChingApp />);
    </script>
</body>
</html>
