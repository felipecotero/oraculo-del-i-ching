<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Ching: El Espejo de las Mutaciones (Versi√≥n Maestra)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', 'serif'],
                        cinzel: ['Cinzel', 'serif'],
                    },
                    colors: {
                        ink: '#111111',      // Negro Tinta
                        paper: '#F2E8D5',    // Papel Arroz
                        cinnabar: '#9A1B1B', // Rojo Sangre
                        jade: '#3A5F4C',     // Jade Profundo
                        gold: '#C5A059',     // Oro Viejo
                    },
                    animation: {
                        'fadeIn': 'fadeIn 1.2s ease-out forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #F2E8D5;
            color: #111111;
            /* Textura de papel */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.12'/%3E%3C/svg%3E");
            overflow-x: hidden;
        }
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 200px rgba(40, 30, 15, 0.5);
            pointer-events: none; z-index: 0;
        }
        /* Estilo para simular tinta china */
        .ink-brush {
            background-color: #111;
            mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='rough'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.05' numOctaves='2'/%3E%3CfeDisplacementMap in='SourceGraphic' scale='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23rough)'/%3E%3C/svg%3E");
            opacity: 0.9;
        }
        .hex-sticky {
            position: sticky;
            top: 2rem;
            align-self: start;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #9A1B1B; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="vignette"></div>
    <div id="root" class="relative z-10 min-h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { jsPDF } = window.jspdf;

        // --- CLAVE API ---
        const apiKey = "AIzaSyBRwAd5v0Pgbh6QjWBLAuCy28Z8BG0Fwig"; 

        // --- PAISAJES SVG INCORPORADOS (Nunca fallan) ---
        // Definidos ANTES de que cualquier componente los intente usar
        const INK_LANDSCAPES = [
            `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E%3Cpath d='M0 200L200 100C250 80 300 150 400 50C500 -50 600 150 800 100V200H0Z' fill='%23111' opacity='0.1'/%3E%3Cpath d='M100 200L300 50C350 30 400 120 500 80C600 40 700 180 800 150V200H100Z' fill='%23111' opacity='0.2'/%3E%3C/svg%3E`,
            `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E%3Cpath d='M0 150C200 180 300 100 500 120C700 140 750 80 800 100V200H0Z' fill='%23111' opacity='0.1'/%3E%3Cpath d='M0 180C250 200 400 120 600 150C750 180 780 140 800 160V200H0Z' fill='%23111' opacity='0.2'/%3E%3C/svg%3E`,
            `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E%3Ccircle cx='100' cy='50' r='80' fill='%23111' opacity='0.05'/%3E%3Ccircle cx='250' cy='80' r='100' fill='%23111' opacity='0.08'/%3E%3Ccircle cx='500' cy='40' r='120' fill='%23111' opacity='0.05'/%3E%3Ccircle cx='700' cy='90' r='90' fill='%23111' opacity='0.08'/%3E%3C/svg%3E`,
            `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 200'%3E%3Crect x='50' y='0' width='10' height='200' fill='%23111' opacity='0.1'/%3E%3Crect x='150' y='20' width='8' height='180' fill='%23111' opacity='0.15'/%3E%3Crect x='700' y='50' width='12' height='150' fill='%23111' opacity='0.1'/%3E%3C/svg%3E`
        ];

        // --- SISTEMA DE TRIGRAMAS ---
        const TRIGRAMS = {
            '111': { name: "Ch'ien", element: "Cielo", meaning: "Lo Creativo", quality: "Fuerza, Persistencia, Autoridad Paterna", subjective: "Tu voluntad es firme e incansable.", objective: "El entorno es din√°mico, exigente y potente." },
            '000': { name: "K'un", element: "Tierra", meaning: "Lo Receptivo", quality: "Entrega, Nutrici√≥n, Espacio Materno", subjective: "Tu actitud es de aceptaci√≥n y soporte.", objective: "La situaci√≥n requiere que te dejes guiar y sirvas de base." },
            '100': { name: "Chen", element: "Trueno", meaning: "Lo Suscitativo", quality: "Movimiento, Iniciativa, Conmoci√≥n", subjective: "Sientes un impulso de actuar o cambiar.", objective: "El entorno est√° agitado, hay sorpresas o nuevos comienzos." },
            '010': { name: "K'an", element: "Agua", meaning: "Lo Abismal", quality: "Peligro, Profundidad, Emoci√≥n", subjective: "Hay miedo o una profunda intuici√≥n emocional.", objective: "La situaci√≥n es incierta, riesgosa o requiere adaptaci√≥n." },
            '001': { name: "Ken", element: "Monta√±a", meaning: "El Aquietamiento", quality: "Quietud, L√≠mite, Detenci√≥n", subjective: "Buscas detenerte o meditar.", objective: "Hay obst√°culos s√≥lidos o un momento de pausa obligada." },
            '110': { name: "Sun", element: "Viento/Madera", meaning: "Lo Suave", quality: "Penetraci√≥n, Crecimiento Org√°nico", subjective: "Te mueves con indecisi√≥n o suave persistencia.", objective: "Las cosas influyen sutilmente, como el viento o las ra√≠ces." },
            '101': { name: "Li", element: "Fuego", meaning: "Lo Adherente", quality: "Claridad, Visi√≥n, Dependencia", subjective: "Buscas claridad o ser reconocido.", objective: "Todo est√° expuesto a la luz; relaciones de dependencia mutua." },
            '011': { name: "Tui", element: "Lago", meaning: "Lo Sereno", quality: "Alegr√≠a, Apertura, Comunicaci√≥n", subjective: "Deseas comunicar o disfrutar.", objective: "El ambiente es propicio para el intercambio y el placer." }
        };

        // --- MAPA BINARIO (REY WEN) ---
        const KING_WEN_MAP = {
            '111111': 1, '000000': 2, '100010': 3, '010001': 4, '111010': 5, '010111': 6, '010000': 7, '000010': 8,
            '111011': 9, '110111': 10, '111000': 11, '000111': 12, '101111': 13, '111101': 14, '001000': 15, '000100': 16,
            '100110': 17, '011001': 18, '110000': 19, '000011': 20, '100101': 21, '101001': 22, '000001': 23, '100000': 24,
            '100111': 25, '111001': 26, '100001': 27, '011110': 28, '010010': 29, '101101': 30, '001110': 31, '011100': 32,
            '001111': 33, '111100': 34, '000101': 35, '101000': 36, '101010': 37, '010101': 38, '001010': 39, '010100': 40,
            '110001': 41, '100011': 42, '111110': 43, '011111': 44, '000110': 45, '011000': 46, '010110': 47, '011010': 48,
            '101110': 49, '011101': 50, '100100': 51, '001001': 52, '001011': 53, '110100': 54, '101100': 55, '001101': 56,
            '011011': 57, '110110': 58, '010011': 59, '110010': 60, '110011': 61, '001100': 62, '101010': 63, '010101': 64
        };

        // --- CATALOGO COMPLETO DE NOMBRES ---
        const HEX_META = {
            1: {n: "Ch'ien", t: "Lo Creativo"}, 2: {n: "K'un", t: "Lo Receptivo"},
            3: {n: "Chun", t: "La Dificultad Inicial"}, 4: {n: "Meng", t: "La Necedad Juvenil"},
            5: {n: "Hs√º", t: "La Espera"}, 6: {n: "Sung", t: "El Conflicto"},
            7: {n: "Shih", t: "El Ej√©rcito"}, 8: {n: "Pi", t: "La Solidaridad"},
            9: {n: "Hsiao Ch'u", t: "La Fuerza Domesticadora de lo Peque√±o"}, 10: {n: "L√º", t: "El Porte"},
            11: {n: "T'ai", t: "La Paz"}, 12: {n: "P'i", t: "El Estancamiento"},
            13: {n: "T'ung Jen", t: "La Comunidad con los Hombres"}, 14: {n: "Ta Yu", t: "La Gran Posesi√≥n"},
            15: {n: "Ch'ien", t: "La Modestia"}, 16: {n: "Y√º", t: "El Entusiasmo"},
            17: {n: "Sui", t: "El Seguimiento"}, 18: {n: "Ku", t: "El Trabajo en lo Echado a Perder"},
            19: {n: "Lin", t: "El Acercamiento"}, 20: {n: "Kuan", t: "La Contemplaci√≥n"},
            21: {n: "Shih Ho", t: "La Mordedura Tajante"}, 22: {n: "Pi", t: "La Gracia"},
            23: {n: "Po", t: "La Desintegraci√≥n"}, 24: {n: "Fu", t: "El Retorno"},
            25: {n: "Wu Wang", t: "La Inocencia"}, 26: {n: "Ta Ch'u", t: "La Fuerza Domesticadora de lo Grande"},
            27: {n: "I", t: "La Nutrici√≥n"}, 28: {n: "Ta Kuo", t: "La Preponderancia de lo Grande"},
            29: {n: "K'an", t: "Lo Abismal"}, 30: {n: "Li", t: "Lo Adherente"},
            31: {n: "Hsien", t: "El Influjo"}, 32: {n: "Heng", t: "La Duraci√≥n"},
            33: {n: "Tun", t: "La Retirada"}, 34: {n: "Ta Chuang", t: "El Poder de lo Grande"},
            35: {n: "Chin", t: "El Progreso"}, 36: {n: "Ming I", t: "El Oscurecimiento de la Luz"},
            37: {n: "Chia Jen", t: "La Familia"}, 38: {n: "K'uei", t: "El Antagonismo"},
            39: {n: "Chien", t: "El Impedimento"}, 40: {n: "Hsieh", t: "La Liberaci√≥n"},
            41: {n: "Sun", t: "La Merma"}, 42: {n: "I", t: "El Aumento"},
            43: {n: "Kuai", t: "La Resoluci√≥n"}, 44: {n: "Kou", t: "El Acoplamiento"},
            45: {n: "Ts'ui", t: "La Reuni√≥n"}, 46: {n: "Sheng", t: "El Ascenso"},
            47: {n: "K'un", t: "La Desaz√≥n"}, 48: {n: "Ching", t: "El Pozo"},
            49: {n: "Ko", t: "La Revoluci√≥n"}, 50: {n: "Ting", t: "El Caldero"},
            51: {n: "Chen", t: "Lo Suscitativo"}, 52: {n: "Ken", t: "El Aquietamiento"},
            53: {n: "Chien", t: "La Evoluci√≥n"}, 54: {n: "Kuei Mei", t: "La Muchacha que se Casa"},
            55: {n: "Feng", t: "La Plenitud"}, 56: {n: "L√º", t: "El Andariego"},
            57: {n: "Sun", t: "Lo Suave"}, 58: {n: "Tui", t: "Lo Sereno"},
            59: {n: "Huan", t: "La Disoluci√≥n"}, 60: {n: "Chieh", t: "La Restricci√≥n"},
            61: {n: "Chung Fu", t: "La Verdad Interior"}, 62: {n: "Hsiao Kuo", t: "La Peque√±a Preponderancia"},
            63: {n: "Chi Chi", t: "Despu√©s de la Consumaci√≥n"}, 64: {n: "Wei Chi", t: "Antes de la Consumaci√≥n"}
        };

        // --- BASE DE DATOS CAN√ìNICA (1-64) ---
        const ORACLE_DB = {
            1: { n: "Ch'ien", t: "Lo Creativo", d: "El Creativo obra elevado logro. Propicio es perseverar.", i: "El movimiento del cielo es vigoroso. As√≠ el hombre noble se hace fuerte e incansable." },
            2: { n: "K'un", t: "Lo Receptivo", d: "Lo Receptivo obra elevado √©xito. Propicia es la perseverancia de una yegua.", i: "La condici√≥n de la tierra es la entrega receptiva. As√≠ el noble sostiene el mundo exterior." },
            3: { n: "Chun", t: "La Dificultad Inicial", d: "La Dificultad Inicial obra elevado √©xito. Propicio es perseverar. No se debe emprender nada.", i: "Nubes y Trueno: la imagen de la Dificultad Inicial." },
            4: { n: "Meng", t: "La Necedad Juvenil", d: "La Necedad Juvenil tiene √©xito. No soy yo quien busca al joven necio, √©l me busca a m√≠.", i: "En el pie de la monta√±a surge un manantial: la imagen de la Juventud." },
            5: { n: "Hs√º", t: "La Espera", d: "La Espera. Si eres veraz, tendr√°s luz y √©xito. La perseverancia trae ventura.", i: "Nubes suben al cielo: la imagen de la Espera." },
            6: { n: "Sung", t: "El Conflicto", d: "El Conflicto. Eres veraz y te frenan. Detenerse con cautela a mitad de camino trae ventura.", i: "El cielo y el agua se mueven en direcciones opuestas." },
            7: { n: "Shih", t: "El Ej√©rcito", d: "El Ej√©rcito. El ej√©rcito necesita perseverancia y un hombre fuerte. Ventura sin tacha.", i: "En el centro de la tierra hay agua: la imagen del Ej√©rcito." },
            8: { n: "Pi", t: "La Solidaridad", d: "La Solidaridad trae ventura. Indaga el or√°culo una vez m√°s.", i: "Sobre la tierra hay agua: la imagen de la Solidaridad." },
            9: { n: "Hsiao Ch'u", t: "La Fuerza Domesticadora de lo Peque√±o", d: "√âxito. Densas nubes, ninguna lluvia de nuestra regi√≥n del oeste.", i: "El viento sopla a trav√©s del cielo." },
            10: { n: "L√º", t: "El Porte", d: "Pisar la cola del tigre. √âste no muerde al hombre. √âxito.", i: "Arriba el cielo, abajo el lago: la imagen del Porte." },
            11: { n: "T'ai", t: "La Paz", d: "La Paz. Lo peque√±o se va, llega lo grande. Ventura. √âxito.", i: "El cielo y la tierra se unen: la imagen de la Paz." },
            12: { n: "P'i", t: "El Estancamiento", d: "El Estancamiento. Los malvados no favorecen la perseverancia del noble.", i: "Cielo y tierra no se unen: la imagen del Estancamiento." },
            13: { n: "T'ung Jen", t: "La Comunidad con los Hombres", d: "La Comunidad con los Hombres en lo libre. √âxito. Es propicio atravesar las grandes aguas.", i: "Cielo junto con fuego: la imagen de la Comunidad." },
            14: { n: "Ta Yu", t: "La Gran Posesi√≥n", d: "La Gran Posesi√≥n. √âxito en medida suprema.", i: "El fuego en lo alto del cielo: la imagen de la Gran Posesi√≥n." },
            15: { n: "Ch'ien", t: "La Modestia", d: "La Modestia crea √©xito. El noble lleva a buen t√©rmino.", i: "En medio de la tierra hay una monta√±a: la imagen de la Modestia." },
            16: { n: "Y√º", t: "El Entusiasmo", d: "El Entusiasmo. Es propicio designar ayudantes y hacer marchar ej√©rcitos.", i: "El trueno surge estruendoso de la tierra: la imagen del Entusiasmo." },
            17: { n: "Sui", t: "El Seguimiento", d: "El Seguimiento tiene elevado √©xito. Propicia es la perseverancia. Sin tacha.", i: "En el centro del lago est√° el trueno: la imagen del Seguimiento." },
            18: { n: "Ku", t: "El Trabajo en lo Echado a Perder", d: "Tiene elevado √©xito. Es propicio atravesar las grandes aguas.", i: "El viento sopla bajo la monta√±a: la imagen de la Deterioraci√≥n." },
            19: { n: "Lin", t: "El Acercamiento", d: "Tiene elevado √©xito. Propicia es la perseverancia. Al llegar el octavo mes habr√° desventura.", i: "La tierra encima del lago: la imagen del Acercamiento." },
            20: { n: "Kuan", t: "La Contemplaci√≥n", d: "Se ha cumplido la abluci√≥n, pero a√∫n no la ofrenda.", i: "El viento sopla sobre la tierra: la imagen de la Contemplaci√≥n." },
            21: { n: "Shih Ho", t: "La Mordedura Tajante", d: "Tiene √©xito. Es propicio dejar que se ejerza la justicia.", i: "Trueno y rel√°mpago: la imagen de la Mordedura Tajante." },
            22: { n: "Pi", t: "La Gracia", d: "√âxito. En lo peque√±o es propicio emprender algo.", i: "Fuego al pie de la monta√±a: la imagen de la Gracia." },
            23: { n: "Po", t: "La Desintegraci√≥n", d: "No es propicio ir a parte alguna.", i: "La monta√±a descansa sobre la tierra: la imagen de la Desintegraci√≥n." },
            24: { n: "Fu", t: "El Retorno", d: "√âxito. Salidas y entradas sin falla. Al s√©ptimo d√≠a viene el retorno.", i: "El trueno dentro de la tierra: la imagen del Retorno." },
            25: { n: "Wu Wang", t: "La Inocencia", d: "Elevado √©xito. La perseverancia es propicia. Si uno no es recto, tendr√° desventura.", i: "Bajo el cielo marcha el trueno: la imagen de la Inocencia." },
            26: { n: "Ta Ch'u", t: "La Fuerza Domesticadora de lo Grande", d: "Propicia es la perseverancia. No comer en casa trae ventura.", i: "El cielo dentro de la monta√±a: la imagen de la Fuerza Domesticadora." },
            27: { n: "I", t: "La Nutrici√≥n", d: "La perseverancia trae ventura. Presta atenci√≥n a la nutrici√≥n.", i: "Al pie de la monta√±a est√° el trueno: la imagen de la Nutrici√≥n." },
            28: { n: "Ta Kuo", t: "La Preponderancia de lo Grande", d: "La viga maestra se dobla hacia abajo. Es propicio tener a donde ir.", i: "El lago inunda por encima de los √°rboles." },
            29: { n: "K'an", t: "Lo Abismal", d: "Si eres veraz, tendr√°s √©xito en tu coraz√≥n.", i: "El agua fluye ininterrumpidamente y llega a la meta." },
            30: { n: "Li", t: "Lo Adherente", d: "Es propicia la perseverancia. Trae √©xito. Cuidar de la vaca trae ventura.", i: "La claridad se eleva dos veces: la imagen del Fuego." },
            31: { n: "Hsien", t: "El Influjo", d: "√âxito. Es propicia la perseverancia. Tomar una muchacha trae ventura.", i: "Sobre la monta√±a hay un lago: la imagen del Influjo." },
            32: { n: "Heng", t: "La Duraci√≥n", d: "√âxito. No hay tacha. Es propicio tener a donde ir.", i: "Trueno y viento: la imagen de la Duraci√≥n." },
            33: { n: "Tun", t: "La Retirada", d: "√âxito. En lo peque√±o es propicia la perseverancia.", i: "Bajo el cielo est√° la monta√±a: la imagen de la Retirada." },
            34: { n: "Ta Chuang", t: "El Poder de lo Grande", d: "Es propicia la perseverancia.", i: "El trueno est√° en lo alto del cielo: la imagen del Gran Poder." },
            35: { n: "Chin", t: "El Progreso", d: "El fuerte pr√≠ncipe es honrado con caballos en gran n√∫mero.", i: "El sol se eleva sobre la tierra: la imagen del Progreso." },
            36: { n: "Ming I", t: "El Oscurecimiento de la Luz", d: "Es propicio ser perseverante en la emergencia.", i: "La luz se ha sumergido en la tierra: la imagen del Oscurecimiento." },
            37: { n: "Chia Jen", t: "La Familia", d: "Es propicia la perseverancia de la mujer.", i: "El viento surge del fuego: la imagen de la Familia." },
            38: { n: "K'uei", t: "El Antagonismo", d: "En cosas peque√±as, ventura.", i: "Arriba el fuego, abajo el lago: la imagen del Antagonismo." },
            39: { n: "Chien", t: "El Impedimento", d: "Es propicio el oeste y el sur. No es propicio el este y el norte.", i: "Sobre la monta√±a hay agua: la imagen del Impedimento." },
            40: { n: "Hsieh", t: "La Liberaci√≥n", d: "Es propicio el oeste y el sur. Si no hay m√°s nada a donde uno debiera ir, es venturoso el regreso.", i: "El trueno y la lluvia surgen: la imagen de la Liberaci√≥n." },
            41: { n: "Sun", t: "La Merma", d: "Si hay veracidad, se logra elevado √©xito. No hay tacha.", i: "Al pie de la monta√±a est√° el lago: la imagen de la Merma." },
            42: { n: "I", t: "El Aumento", d: "Es propicio emprender algo. Es propicio atravesar las grandes aguas.", i: "Viento y trueno: la imagen del Aumento." },
            43: { n: "Kuai", t: "La Resoluci√≥n", d: "Uno debe dar a conocer el asunto en la corte del rey. Despachar una ciudad.", i: "El lago ha subido al cielo: la imagen de la Irrupci√≥n." },
            44: { n: "Kou", t: "El Acoplamiento", d: "La muchacha es poderosa. No se debe tomar a esta muchacha.", i: "Bajo el cielo est√° el viento: la imagen del Acoplamiento." },
            45: { n: "Ts'ui", t: "La Reuni√≥n", d: "√âxito. El rey se acerca a su templo. Propicio es ver al gran hombre.", i: "El lago sobre la tierra: la imagen de la Reuni√≥n." },
            46: { n: "Sheng", t: "El Ascenso", d: "Elevado √©xito. Hay que ver al gran hombre.", i: "En el centro de la tierra crece madera: la imagen del Ascenso." },
            47: { n: "K'un", t: "La Desaz√≥n", d: "√âxito. Perseverancia. El gran hombre opera ventura. Ninguna tacha.", i: "El lago no tiene agua: la imagen del Agotamiento." },
            48: { n: "Ching", t: "El Pozo", d: "Uno cambia de ciudad, pero no cambia de pozo.", i: "Sobre la madera hay agua: la imagen del Pozo." },
            49: { n: "Ko", t: "La Revoluci√≥n", d: "En tu propio d√≠a encontrar√°s fe. Elevado √©xito.", i: "Fuego en el lago: la imagen de la Revoluci√≥n." },
            50: { n: "Ting", t: "El Caldero", d: "Elevada ventura. √âxito.", i: "Por encima de la madera hay fuego: la imagen del Caldero." },
            51: { n: "Chen", t: "Lo Suscitativo", d: "Llega la conmoci√≥n. ¬°Ju, ju! Palabras rientes, ¬°ja, ja!", i: "El trueno repetido: la imagen de la Conmoci√≥n." },
            52: { n: "Ken", t: "El Aquietamiento", d: "Aquietar su espalda, de modo que √©l no sienta m√°s su cuerpo.", i: "Monta√±as estribadas: la imagen del Aquietamiento." },
            53: { n: "Chien", t: "La Evoluci√≥n", d: "La muchacha se casa. Ventura. Es propicia la perseverancia.", i: "Sobre la monta√±a hay un √°rbol: la imagen de la Evoluci√≥n." },
            54: { n: "Kuei Mei", t: "La Muchacha que se Casa", d: "Las empresas traen desventura. Nada que fuese propicio.", i: "Sobre el lago hay un trueno: la imagen de la Muchacha que se Casa." },
            55: { n: "Feng", t: "La Plenitud", d: "El rey la alcanza. No est√©s triste. Hay que ser como el sol al mediod√≠a.", i: "Trueno y rayos llegan a la vez: la imagen de la Plenitud." },
            56: { n: "L√º", t: "El Andariego", d: "√âxito en lo peque√±o. Al andariego la perseverancia le trae ventura.", i: "Fuego sobre la monta√±a: la imagen del Andariego." },
            57: { n: "Sun", t: "Lo Suave", d: "√âxito en lo peque√±o. Es propicio tener a donde ir.", i: "Vientos seguidos: la imagen de lo Suave." },
            58: { n: "Tui", t: "Lo Sereno", d: "√âxito. Es propicia la perseverancia.", i: "Lagos que reposan uno sobre otro: la imagen de lo Sereno." },
            59: { n: "Huan", t: "La Disoluci√≥n", d: "√âxito. El rey se acerca a su templo.", i: "El viento roza por encima el agua: la imagen de la Disoluci√≥n." },
            60: { n: "Chieh", t: "La Restricci√≥n", d: "√âxito. Una restricci√≥n amarga no se debe perseverar.", i: "Agua sobre el lago: la imagen de la Restricci√≥n." },
            61: { n: "Chung Fu", t: "La Verdad Interior", d: "Cerdos y peces. ¬°Ventura! Es propicio cruzar las grandes aguas.", i: "Viento sobre el lago: la imagen de la Verdad Interior." },
            62: { n: "Hsiao Kuo", t: "La Preponderancia de lo Peque√±o", d: "Es propicia la perseverancia. Peque√±as cosas pueden hacerse.", i: "Trueno sobre la monta√±a: la imagen de la Preponderancia de lo Peque√±o." },
            63: { n: "Chi Chi", t: "Despu√©s de la Consumaci√≥n", d: "√âxito en lo peque√±o. Al principio ventura, al final desorden.", i: "El agua est√° sobre el fuego: la imagen del estado despu√©s de la consumaci√≥n." },
            64: { n: "Wei Chi", t: "Antes de la Consumaci√≥n", d: "Si el peque√±o zorro, al casi completar el cruce, se moja la cola, nada es propicio.", i: "El fuego est√° sobre el agua: la imagen del estado antes de la consumaci√≥n." }
        };

        // --- MOTOR DE AN√ÅLISIS ESTRUCTURAL PROFUNDO ---
        const generateDeepAnalysis = (upperBin, lowerBin, hexName) => {
            const upper = TRIGRAMS[upperBin];
            const lower = TRIGRAMS[lowerBin];
            
            // C√°lculo Nuclear
            const fullBin = lowerBin + upperBin; 
            const nLowerBin = fullBin[1] + fullBin[2] + fullBin[3];
            const nUpperBin = fullBin[2] + fullBin[3] + fullBin[4];
            const nFullBin = nLowerBin + nUpperBin;
            const nuclearId = KING_WEN_MAP[nFullBin];
            const nuclearTitle = ORACLE_DB[nuclearId]?.t || "Desconocido";

            return `
AN√ÅLISIS DE LA ARQUITECTURA DEL TIEMPO (${hexName.toUpperCase()})

1. LA DIN√ÅMICA DE LOS ELEMENTOS (ENOS LONG)
Este hexagrama se construye sobre la tensi√≥n o armon√≠a entre el Mundo Interno (Trigrama Inferior: ${lower.element}) y el Mundo Externo (Trigrama Superior: ${upper.element}).

TU POSICI√ìN SUBJETIVA (${lower.name} - ${lower.meaning}):
${lower.subjective}
Representa tu base psicol√≥gica actual: la ra√≠z desde donde act√∫as.

LA REALIDAD OBJETIVA (${upper.name} - ${upper.meaning}):
${upper.objective}
Representa las circunstancias que te rodean o lo que viene hacia ti desde afuera.

LA INTERACCI√ìN:
La imagen es "${upper.element} sobre ${lower.element}". 
${upperBin === lowerBin 
? `Al duplicarse el elemento ${upper.element}, la energ√≠a no encuentra oposici√≥n, sino resonancia. Es un tiempo de intensificaci√≥n pura de la cualidad "${upper.quality}". La lecci√≥n es la consistencia.` 
: `¬øC√≥mo interact√∫an? ${lower.element} (adentro) trata de moverse hacia ${upper.element} (afuera). Es el di√°logo entre ${lower.quality} y ${upper.quality}.`}

2. EL HEXAGRAMA NUCLEAR (LA SEMILLA OCULTA)
Dentro de este signo, escondido en su estructura (l√≠neas 2 a 5), yace el Hexagrama Nuclear: ${nuclearId} - ${nuclearTitle}.
Este signo representa la tendencia latente, el potencial oculto o el miedo subyacente que motiva la situaci√≥n actual. La energ√≠a de "${TRIGRAMS[nLowerBin].element}" y "${TRIGRAMS[nUpperBin].element}" est√° gest√°ndose en lo profundo.

3. LA PERSPECTIVA TEMPORAL (OSVALDO LOISI)
Este no es un evento est√°tico, es un "Tiempo". Como ense√±a Loisi, el or√°culo delimita un "coto cerrado" de experiencia humana. Est√°s transitando la estaci√≥n de "${hexName}". La clave para salir de este tiempo o aprovecharlo no es luchar contra √©l, sino alinearte con su "Impronta". Si el tiempo es de ${upper.quality}, actuar con impaciencia solo generar√° desorden. Si el tiempo es de ${lower.quality}, la pasividad ser√° un error.
            `;
        };

        // --- CITAS MUTANTES ---
        const INTRO_QUOTES = [
            { t: "El camino es fatal como la flecha,\npero en las grietas est√° Dios, que acecha.", a: "Jorge Luis Borges", s: "Para una versi√≥n del I King" },
            { t: "El tiempo es un r√≠o que me arrebata, pero yo soy el r√≠o;\nes un tigre que me destroza, pero yo soy el tigre.", a: "Jorge Luis Borges", s: "Nueva refutaci√≥n del tiempo" },
            { t: "No hay un solo instante que no est√© cargado de pasado.", a: "Jorge Luis Borges", s: "El jard√≠n de senderos que se bifurcan" },
            { t: "Somos nuestra memoria, somos ese quim√©rico museo de formas inconstantes.", a: "Jorge Luis Borges", s: "Elogio de la Sombra" }
        ];

        // --- BASE DE DATOS MAESTRA ---
        const getHexInfo = (linesInput) => {
            const bin = linesInput.map(l => (l===7||l===9)?'1':'0').join('');
            const id = KING_WEN_MAP[bin];
            const dbEntry = ORACLE_DB[id];
            
            // An√°lisis Din√°mico
            const lowerBin = bin.substring(0,3);
            const upperBin = bin.substring(3,6);
            const analysis = generateDeepAnalysis(upperBin, lowerBin, dbEntry.t);
            const inkImage = generateProceduralInk(upperBin, lowerBin); // SVG por defecto

            // Jodorowsky generico por ahora
            const jodorowsky = {
                p: "Tu intuici√≥n completar√° el sentido.",
                a: "Medita en silencio sobre el nombre de este hexagrama y realiza un acto simb√≥lico de cambio."
            };

            return { ...dbEntry, id, analysis, inkImage, j: jodorowsky };
        };

        // --- COMPONENTE PRINCIPAL ---
        function IChingApp() {
            const [phase, setPhase] = useState('INTRO');
            const [method, setMethod] = useState(null);
            const [lines, setLines] = useState([]); 
            const [quote, setQuote] = useState(INTRO_QUOTES[0]);
            const [readings, setReadings] = useState([]);
            const [showBitacora, setShowBitacora] = useState(false);
            const [genImage, setGenImage] = useState(INK_LANDSCAPES[0]); 
            const [isGenerating, setIsGenerating] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => {
                const stored = localStorage.getItem('iching_master_log');
                if(stored) setReadings(JSON.parse(stored));
                setQuote(INTRO_QUOTES[Math.floor(Math.random() * INTRO_QUOTES.length)]);
                setGenImage(INK_LANDSCAPES[Math.floor(Math.random() * INK_LANDSCAPES.length)]); 
            }, []);

            // --- GENERAR IMAGEN PROCEDURAL (REEMPLAZA A LA API DE GOOGLE PARA ESTABILIDAD) ---
            const generateHexagramVisual = async (info) => {
                setIsGenerating(true);
                
                // Intento de generaci√≥n con Nano Banana si la clave est√° presente
                if (apiKey) {
                    const prompt = `Ancient Chinese ink wash painting style, minimalist line drawing. Abstract representation of I Ching Hexagram "${info.t}". Concept: ${info.i}. Deep meaning: ${info.analysis.substring(0, 100)}... Black ink on old paper texture, mystical, serene, traditional art.`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } })
                        });
                        const result = await response.json();
                        if (result.predictions?.[0]?.bytesBase64Encoded) {
                            setGenImage(`data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`);
                            setIsGenerating(false);
                            return; // √âxito, salimos
                        }
                    } catch (e) {
                        console.error("Error API Imagen:", e);
                    }
                }

                // Fallback a SVG si no hay API o falla
                setTimeout(() => {
                    setGenImage(info.inkImage);
                    setIsGenerating(false);
                }, 1500);
            };

            const saveReading = (linesInput) => {
                const info = getHexInfo(linesInput);
                const newR = { id: Date.now(), date: new Date().toLocaleString(), lines: linesInput, hexId: info.id, title: info.t };
                
                const last = readings[0];
                if(last && last.lines.join('') === linesInput.join('') && Date.now() - last.id < 5000) return;

                const updated = [newR, ...readings];
                setReadings(updated);
                localStorage.setItem('iching_master_log', JSON.stringify(updated));
            };

            // PROBABILIDADES AJUSTADAS POR M√âTODO
            const castLine = () => {
                const r = Math.random() * 16;
                if (method === 'coin') return r < 2 ? 6 : r < 8 ? 7 : r < 14 ? 8 : 9;
                return r < 1 ? 6 : r < 6 ? 7 : r < 13 ? 8 : 9;
            };

            const handleCast = () => { if (lines.length < 6) setLines(prev => [...prev, castLine()]); };

            useEffect(() => {
                if (lines.length === 6 && phase === 'RITUAL') {
                    setTimeout(() => setPhase('REVELATION'), 1000);
                }
                if(phase === 'RITUAL' && scrollRef.current) scrollRef.current.scrollIntoView({behavior:'smooth'});
            }, [lines, phase]);

            useEffect(() => {
                if(phase === 'REVELATION' && lines.length === 6) {
                    const info = getHexInfo(lines);
                    saveReading(lines);
                    // Generar visual al revelar
                    // generateHexagramVisual(info); 
                }
            }, [phase]);

            const reset = () => {
                setLines([]);
                setPhase('INTRO');
                setMethod(null);
                setGenImage(INK_LANDSCAPES[Math.floor(Math.random() * INK_LANDSCAPES.length)]);
                setQuote(INTRO_QUOTES[Math.floor(Math.random() * INTRO_QUOTES.length)]);
            };

            const reviewReading = (r) => {
                setLines(r.lines);
                setPhase('REVELATION');
                setShowBitacora(false);
                const info = getHexInfo(r.lines);
                // Al revisar, volvemos a un SVG por defecto para dar la opci√≥n de "regenerar"
                setGenImage(info.inkImage); 
            };

            const clearLog = () => {
                if(confirm("¬øQuemar la bit√°cora completa?")) {
                    setReadings([]);
                    localStorage.removeItem('iching_master_log');
                }
            };

            const currentData = (phase === 'REVELATION' && lines.length === 6) ? getHexInfo(lines) : null;
            const movingLines = lines.map((v, i) => (v===6||v===9) ? {line: i+1, val: v} : null).filter(Boolean);

            const downloadPDF = () => {
                if (!currentData) return;
                const doc = new jsPDF();
                
                // Fondo Crema
                doc.setFillColor(242, 232, 213); 
                doc.rect(0,0,210,297,'F');
                
                // Marco Rojo
                doc.setDrawColor(154, 27, 27); // Cinnabar
                doc.setLineWidth(1.5);
                doc.rect(10, 10, 190, 277);
                doc.setLineWidth(0.5);
                doc.rect(12, 12, 186, 273);

                // T√≠tulo
                doc.setTextColor(154, 27, 27); 
                doc.setFontSize(26); 
                doc.setFont("times", "bold");
                doc.text(currentData.t.toUpperCase(), 105, 35, {align:'center'});
                
                // Subt√≠tulo
                doc.setTextColor(20, 20, 20); // Ink
                doc.setFontSize(16); 
                doc.setFont("times", "italic");
                doc.text(`Hexagrama ${currentData.id}: ${currentData.n}`, 105, 45, {align:'center'});

                // L√≠nea divisoria decorativa
                doc.setDrawColor(154, 27, 27);
                doc.line(70, 50, 140, 50);

                // Dictamen
                doc.setFontSize(14);
                doc.setFont("times", "bold");
                doc.setTextColor(154, 27, 27);
                doc.text("DICTAMEN", 20, 65);
                
                doc.setFontSize(12);
                doc.setFont("times", "normal");
                doc.setTextColor(0);
                const splitD = doc.splitTextToSize(currentData.d, 170);
                doc.text(splitD, 20, 72);
                let y = 72 + (splitD.length * 6) + 10;

                // Imagen
                doc.setFontSize(14);
                doc.setFont("times", "bold");
                doc.setTextColor(154, 27, 27);
                doc.text("LA IMAGEN", 20, y);
                y += 7;
                
                doc.setFontSize(12);
                doc.setFont("times", "italic");
                doc.setTextColor(0);
                const splitI = doc.splitTextToSize(currentData.i, 170);
                doc.text(splitI, 20, y);
                y += (splitI.length * 6) + 15;

                // An√°lisis Estructural
                doc.setDrawColor(200, 200, 200);
                doc.line(20, y, 190, y);
                y += 10;

                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                const splitA = doc.splitTextToSize(currentData.analysis, 170);
                doc.text(splitA, 20, y);

                // Pie de p√°gina
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text("Consultado en el Espejo de las Mutaciones", 105, 280, {align:'center'});

                doc.save(`iching_${currentData.id}.pdf`);
            };

            const LineComp = ({ value, showNumber }) => {
                const isYang = value === 7 || value === 9;
                const isMoving = value === 6 || value === 9;
                return (
                    <div className="w-full h-6 md:h-8 my-1 flex items-center justify-center relative">
                        {showNumber && <span className={`absolute -left-8 text-xs font-cinzel ${isMoving?'text-cinnabar font-bold':'text-ink/30'}`}>{value}</span>}
                        <div className="w-full h-full flex justify-between items-center px-1">
                            {isYang ? <div className="w-full h-4 md:h-5 ink-brush rounded-sm shadow-sm"></div> : 
                            <><div className="w-[42%] h-4 md:h-5 ink-brush rounded-sm shadow-sm"></div><div className="w-[42%] h-4 md:h-5 ink-brush rounded-sm shadow-sm"></div></>}
                        </div>
                        {isMoving && <div className="absolute inset-0 flex items-center justify-center"><div className={`w-3 h-3 rounded-full ${value===9?'bg-paper border-2 border-cinnabar':'bg-cinnabar'} animate-pulse`}></div></div>}
                    </div>
                );
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8 font-serif text-ink min-h-screen flex flex-col">
                    <header className="flex justify-between items-center py-6 border-b-2 border-cinnabar/20 mb-8">
                        <div className="w-10"></div>
                        <div className="text-center">
                            <h1 className="text-4xl md:text-5xl font-cinzel font-bold text-cinnabar tracking-widest drop-shadow-sm">I CHING</h1>
                            <p className="text-xs md:text-sm font-cinzel uppercase tracking-[0.3em] opacity-60 mt-2">El Espejo de las Mutaciones</p>
                        </div>
                        <button onClick={() => setShowBitacora(true)} className="text-3xl hover:text-cinnabar transition-colors" title="Bit√°cora">üìú</button>
                    </header>

                    {showBitacora && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            <div className="absolute inset-0 bg-ink/70 backdrop-blur-sm" onClick={() => setShowBitacora(false)}></div>
                            <div className="relative w-full max-w-md bg-paper h-full shadow-2xl p-8 overflow-y-auto animate-fadeIn border-l-4 border-cinnabar flex flex-col">
                                <div className="flex justify-between mb-6 border-b border-cinnabar pb-4">
                                    <h2 className="text-2xl font-cinzel text-cinnabar font-bold">Bit√°cora</h2>
                                    <button onClick={() => setShowBitacora(false)} className="text-2xl hover:text-cinnabar">√ó</button>
                                </div>
                                {readings.length > 0 && <button onClick={() => { if(confirm("¬øBorrar todo?")) { setReadings([]); localStorage.removeItem('iching_master_log'); } }} className="text-xs uppercase tracking-widest text-cinnabar border border-cinnabar px-4 py-2 mb-4 hover:bg-cinnabar hover:text-paper transition-colors self-end">Quemar Pergaminos</button>}
                                <div className="space-y-4 flex-1">
                                    {readings.map(r => (
                                        <div key={r.id} onClick={() => reviewReading(r)} className="bg-white/40 p-4 border border-ink/10 cursor-pointer hover:border-cinnabar transition-colors group relative">
                                            <div className="text-xs font-cinzel opacity-50 mb-1">{r.date}</div>
                                            <div className="font-bold text-lg">#{r.hexId} {r.title}</div>
                                            <div className="flex gap-1 mt-2">{r.lines.map((l,i)=><span key={i} className={`text-xs w-4 text-center ${l===6||l===9?'text-cinnabar font-bold border-b border-cinnabar':''}`}>{l}</span>)}</div>
                                        </div>
                                    ))}
                                    {readings.length === 0 && <p className="text-center italic opacity-50 mt-10">La memoria est√° vac√≠a.</p>}
                                </div>
                            </div>
                        </div>
                    )}

                    {phase === 'INTRO' && (
                        <div className="flex-1 flex flex-col items-center justify-center animate-fadeIn text-center px-4 relative">
                            {/* IMAGEN DE FONDO/CABECERA (Procedural Inicial) */}
                            <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" style={{backgroundImage: `url(${INK_LANDSCAPES[0]})`, backgroundSize: 'cover', backgroundPosition: 'center', filter: 'grayscale(100%)'}}></div>
                            <div className="border-y-2 border-ink/10 py-12 px-8 mb-12 max-w-2xl bg-white/40 shadow-sm relative z-10 backdrop-blur-sm">
                                <p className="text-2xl md:text-3xl italic leading-relaxed whitespace-pre-line text-ink/80">"{quote.t}"</p>
                                <div className="mt-6 flex flex-col items-center"><span className="font-cinzel text-cinnabar font-bold uppercase tracking-widest text-sm">Jorge Luis Borges</span></div>
                            </div>
                            <div className="flex flex-col md:flex-row gap-8 relative z-10">
                                <button onClick={() => { setMethod('yarrow'); setPhase('RITUAL'); }} className="group w-64 p-6 border-2 border-ink/20 hover:border-cinnabar bg-paper hover:bg-white transition-all duration-300 flex flex-col items-center">
                                    <div className="h-12 w-12 rounded-full border border-ink/30 mb-4 flex items-center justify-center group-hover:border-cinnabar">üåø</div>
                                    <span className="font-cinzel font-bold text-lg mb-2">Tallos de Milenrama</span>
                                    <span className="text-xs font-serif italic opacity-60">Lento. Probabilidad Asim√©trica.</span>
                                </button>
                                <button onClick={() => { setMethod('coin'); setPhase('RITUAL'); }} className="group w-64 p-6 border-2 border-ink/20 hover:border-cinnabar bg-paper hover:bg-white transition-all duration-300 flex flex-col items-center">
                                    <div className="h-12 w-12 rounded-full border border-ink/30 mb-4 flex items-center justify-center group-hover:border-cinnabar">ü™ô</div>
                                    <span className="font-cinzel font-bold text-lg mb-2">Tres Monedas</span>
                                    <span className="text-xs font-serif italic opacity-60">R√°pido. Probabilidad Sim√©trica.</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {phase === 'RITUAL' && (
                        <div className="flex-1 flex flex-col items-center py-12 animate-fadeIn">
                            <div className="w-full max-w-xs mb-12 min-h-[400px] flex flex-col-reverse justify-start p-8 bg-white/30 border border-ink/5 shadow-inner rounded-sm">
                                {lines.map((v, i) => <LineComp key={i} value={v} showNumber={true} />)}
                                {lines.length === 0 && <p className="text-center italic opacity-40 mt-auto">El vac√≠o f√©rtil...</p>}
                            </div>
                            {lines.length < 6 ? (
                                <button onClick={handleCast} ref={scrollRef} className="w-24 h-24 rounded-full border-2 border-ink hover:border-cinnabar bg-paper shadow-2xl flex items-center justify-center transition-transform active:scale-95 group relative overflow-hidden">
                                    <div className="absolute inset-0 bg-ink/5 group-hover:bg-cinnabar/10 transition-colors"></div>
                                    <span className="text-3xl">{method === 'yarrow' ? 'üåø' : 'ü™ô'}</span>
                                </button>
                            ) : <p className="font-cinzel text-cinnabar text-xl animate-pulse tracking-widest">Interpretando...</p>}
                            <p className="mt-6 font-mono text-xs uppercase tracking-widest opacity-50">L√≠nea {lines.length + 1} de 6</p>
                        </div>
                    )}

                    {phase === 'REVELATION' && currentData && (
                        <div className="animate-fadeIn pb-20">
                            <div className="w-full h-64 mb-12 overflow-hidden border-y-2 border-ink/10 relative bg-paper flex items-center justify-center group">
                                {isGenerating ? (
                                    <div className="text-center animate-pulse"><div className="text-3xl mb-2">üñåÔ∏è</div><p className="font-cinzel text-ink/50 uppercase tracking-widest text-sm">Pincelando el destino...</p></div>
                                ) : (
                                    <>
                                        <img src={genImage || INK_LANDSCAPES[0]} alt="Paisaje" className="w-full h-full object-cover opacity-80" style={{filter: 'sepia(30%) contrast(110%)'}} />
                                        <div className="absolute inset-0 bg-gradient-to-t from-[#F2E8D5] to-transparent pointer-events-none"></div>
                                        <button onClick={() => generateHexagramVisual(currentData)} className="absolute bottom-4 right-4 bg-ink/80 hover:bg-cinnabar text-paper px-4 py-2 rounded-sm font-cinzel text-xs uppercase tracking-widest shadow-lg transition-all transform hover:scale-105 flex items-center gap-2 border border-paper/20 z-10">
                                            <span>üëÅÔ∏è</span> Invocar Visi√≥n del Or√°culo
                                        </button>
                                    </>
                                )}
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-12">
                                <div className="lg:col-span-4 relative">
                                    <div className="hex-sticky bg-[#F0E6D2] p-8 border-2 border-ink/10 shadow-2xl rounded-sm">
                                        <div className="text-center mb-6">
                                            <h3 className="font-cinzel text-cinnabar text-sm uppercase tracking-[0.3em]">Hexagrama {currentData.id}</h3>
                                            <h2 className="font-serif font-bold text-4xl mt-2 leading-none">{currentData.t}</h2>
                                            <h4 className="font-serif italic text-xl opacity-60 mt-1">{currentData.n}</h4>
                                        </div>
                                        <div className="flex flex-col-reverse gap-2 py-4 border-y border-ink/5">
                                            {lines.map((v, i) => <LineComp key={i} value={v} showNumber={true} />)}
                                        </div>
                                        <div className="mt-6 text-center">
                                            <button onClick={downloadPDF} className="text-xs font-cinzel uppercase tracking-widest border border-cinnabar text-cinnabar px-4 py-2 hover:bg-cinnabar hover:text-paper transition-colors w-full">Descargar PDF</button>
                                            <button onClick={() => { setLines([]); setPhase('INTRO'); setMethod(null); }} className="text-xs font-cinzel uppercase tracking-widest text-ink/40 hover:text-ink mt-4 block w-full">Nueva Lectura</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="lg:col-span-8 space-y-12 pr-4">
                                    <section>
                                        <div className="flex items-center gap-4 mb-6"><div className="h-[1px] bg-cinnabar flex-1"></div><h3 className="font-cinzel text-cinnabar font-bold uppercase tracking-widest">El Dictamen</h3><div className="h-[1px] bg-cinnabar flex-1"></div></div>
                                        <p className="text-2xl font-serif leading-loose text-justify first-letter:text-5xl first-letter:float-left first-letter:mr-3 first-letter:text-cinnabar">{currentData.d}</p>
                                    </section>
                                    <section className="bg-white/40 p-8 border-l-4 border-jade">
                                        <h3 className="font-cinzel text-jade font-bold uppercase tracking-widest mb-4">La Imagen</h3>
                                        <p className="text-xl font-serif italic text-ink/90">"{currentData.i}"</p>
                                    </section>
                                    <section className="bg-ink/5 p-8 rounded-sm">
                                        <h3 className="font-cinzel text-ink/60 font-bold uppercase tracking-widest mb-4 flex items-center gap-2"><span>‚ö°</span> An√°lisis Estructural y Tiempo</h3>
                                        <div className="font-serif text-lg whitespace-pre-line leading-relaxed">{currentData.analysis}</div>
                                    </section>
                                    <section>
                                        <h3 className="font-cinzel text-cinnabar font-bold uppercase tracking-widest mb-6 border-b border-cinnabar/20 pb-2">Las L√≠neas (Mutaciones)</h3>
                                        {movingLines.length === 0 ? <div className="text-center p-8 border border-ink/10 italic opacity-60">No hay l√≠neas mutantes. La situaci√≥n es estable y el Dictamen es absoluto.</div> : 
                                        <div className="space-y-6">{movingLines.map((m, i) => (
                                            <div key={i} className="p-6 bg-white/60 shadow-sm border-l-4 border-cinnabar relative overflow-hidden">
                                                <div className="absolute top-0 right-0 p-4 opacity-10 font-cinzel text-6xl text-cinnabar">{m.val}</div>
                                                <h4 className="font-bold font-cinzel text-cinnabar mb-2 relative z-10">{m.val === 6 ? 'Seis' : 'Nueve'} en el puesto {m.line}</h4>
                                                <p className="font-serif text-lg relative z-10">"Aqu√≠ sucede el cambio. La energ√≠a {m.val===6?'Yin se vuelve Yang':'Yang se vuelve Yin'}. Presta atenci√≥n a este momento espec√≠fico."</p>
                                            </div>
                                        ))}</div>}
                                    </section>
                                    <section className="grid md:grid-cols-2 gap-8">
                                        <div className="bg-jade/10 p-6 border border-jade/20 rounded-sm">
                                            <h4 className="font-cinzel text-jade font-bold text-xs uppercase tracking-widest mb-4">Poesof√≠a</h4>
                                            <p className="font-serif font-bold text-2xl">{currentData.j.p}</p>
                                        </div>
                                        <div className="bg-paper p-6 border border-ink/10 shadow-inner">
                                            <h4 className="font-cinzel text-ink/50 font-bold text-xs uppercase tracking-widest mb-4">Acto Psicom√°gico</h4>
                                            <p className="font-serif italic text-lg leading-relaxed">"{currentData.j.a}"</p>
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IChingApp />);
    </script>
</body>
</html>
